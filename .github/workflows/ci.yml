name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

env:
  # Dummy values for svelte-check type generation
  TURSO_DATABASE_URL: 'libsql://dummy.turso.io'
  TURSO_AUTH_TOKEN: 'dummy-token'
  TURNSTILE_SECRET_KEY: '1x0000000000000000000000000000000AA'
  PUBLIC_TURNSTILE_SITE_KEY: '1x00000000000000000000AA'
  PUBLIC_DEFAULT_CHAT_ROOM_ID: '00000000-0000-0000-0000-000000000001'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
        # version comes from packageManager field in package.json
      - uses: actions/setup-node@v4
        with:
          node-version: '22.13.0'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run check
      - run: pnpm run lint
      - run: pnpm run build

  migrate:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: check
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22.13.0'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - name: Run database migrations
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL_PROD }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN_PROD }}
        run: pnpm db:migrate
